name: Build and Release Image
on:
  push:
    branches:
      - main
    tags:
      - "**"
  pull_request:
    branches:
      - main
  schedule:
    - cron: 0 5 * * *
  workflow_dispatch:
    inputs:
      suffix:
        description: Custom suffix for tag
        required: false
  repository_dispatch:
jobs:
  check-ffmpeg-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changed.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check if Dockerfile changed
        id: changed
        run: |
          if git diff HEAD^ HEAD --name-only | grep -q "utils/ffmpeg/Dockerfile"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Dockerfile changed, will build"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Dockerfile unchanged, skipping build"
          fi

  build-ffmpeg:
    needs: check-ffmpeg-changes
    if: needs.check-ffmpeg-changes.outputs.changed == 'true'
    uses: ibm-skills-network/.github/.github/workflows/release.yml@main
    with:
      image: icr.io/skills-network/media/ffmpeg
      docker_file: utils/ffmpeg/Dockerfile
      docker_context: .
      docker_target: release
      maximize_free_space: true
    secrets: inherit

  build-app:
    needs: build-ffmpeg
    uses: ibm-skills-network/.github/.github/workflows/release.yml@main
    with:
      image: icr.io/skills-network/media
      docker_context: .
      docker_target: release
    secrets: inherit
